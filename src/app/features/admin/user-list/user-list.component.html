<div class="user-list-container">
  <div class="header">
    <h1>Users</h1>
    <div class="header-actions">
      <button class="btn-refresh" (click)="refreshUsers()" title="Refresh">
        <i class="fas fa-sync-alt"></i>
      </button>
      <button class="btn-import" (click)="openImportModal()">
        <i class="fas fa-file-upload"></i>
        Import
      </button>
      <button class="btn-add" (click)="openAddUserModal()">
        <i class="fas fa-plus"></i>
        Add New User
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <div class="filters-container">
    <!-- Primary Filters Row -->
    <div class="filters-primary">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input
          type="text"
          placeholder="Search users..."
          [value]="searchTerm"
          (input)="onSearchChange($event)">
      </div>

      <div class="filter-buttons">
        <button
          class="btn-filter"
          [class.active]="statusFilter === 'all'"
          (click)="onStatusFilterChange('all')">
          All
        </button>
        <button
          class="btn-filter"
          [class.active]="statusFilter === 'active'"
          (click)="onStatusFilterChange('active')">
          Active
        </button>
        <button
          class="btn-filter"
          [class.active]="statusFilter === 'inactive'"
          (click)="onStatusFilterChange('inactive')">
          Inactive
        </button>
      </div>
    </div>

    <!-- Location Filters Row -->
    <div class="location-filters" *ngIf="true">
      <div class="location-filters-header">
        <span class="filters-section-title">
          <i class="fas fa-map-marker-alt"></i>
          Location Filters
        </span>
        <button
          *ngIf="stateFilter || cityFilter || centerFilter"
          class="btn-clear-filters"
          (click)="clearFilters()"
          title="Clear all location filters">
          <i class="fas fa-times"></i>
          Clear Filters
        </button>
      </div>

      <div class="location-filters-grid">
        <!-- State Filter -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="fas fa-map"></i>
            State
          </label>
          <div class="custom-select" [class.open]="isStateDropdownOpen">
            <div class="select-trigger" (click)="toggleStateDropdown()">
              <span class="select-value">{{ getSelectedStateName() }}</span>
              <i class="fas" [ngClass]="isStateDropdownOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <div class="select-dropdown" *ngIf="isStateDropdownOpen">
              <div class="select-options" (scroll)="onStateScroll($event)">
                <div
                  *ngFor="let state of states"
                  class="select-option"
                  [class.selected]="stateFilter === state.name"
                  (click)="selectState(state)">
                  {{ state.name }}
                </div>
                <div *ngIf="statesLoading" class="select-loading">
                  <i class="fas fa-spinner fa-spin"></i> Loading more...
                </div>
                <div *ngIf="!statesLoading && states.length === 0" class="select-empty">
                  No states found
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- City Filter -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="fas fa-city"></i>
            City
          </label>
          <div class="custom-select" [class.open]="isCityDropdownOpen" [class.disabled]="!stateFilter">
            <div class="select-trigger" (click)="toggleCityDropdown()" [class.disabled]="!stateFilter">
              <span class="select-value">{{ getSelectedCityName() }}</span>
              <i class="fas" [ngClass]="isCityDropdownOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <div class="select-dropdown" *ngIf="isCityDropdownOpen && stateFilter">
              <div class="select-options" (scroll)="onCityScroll($event)">
                <div
                  *ngFor="let city of cities"
                  class="select-option"
                  [class.selected]="cityFilter === city.name"
                  (click)="selectCity(city)">
                  {{ city.name }}
                </div>
                <div *ngIf="citiesLoading" class="select-loading">
                  <i class="fas fa-spinner fa-spin"></i> Loading more...
                </div>
                <div *ngIf="!citiesLoading && cities.length === 0" class="select-empty">
                  No cities found
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Center/Taluka Filter -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="fas fa-building"></i>
            Taluka
          </label>
          <input
            type="text"
            class="filter-input"
            placeholder="Enter taluka/center..."
            [(ngModel)]="centerFilter"
            (input)="onCenterChange()">
        </div>
      </div>
    </div>
  </div>

  <!-- Results meta -->
  <div class="results-meta" *ngIf="!loading && totalUsers > 0">
    <span>{{ rangeStart }}–{{ rangeEnd }} of {{ totalUsers }} users</span>
  </div>

  <!-- Import Modal -->
  <div class="modal-overlay" *ngIf="showImportModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Import Users from Excel</h3>
        <div class="modal-actions">
          <button class="btn-link" (click)="downloadTemplate()" title="Download template">
            <i class="fas fa-download"></i>
            Template
          </button>
          <button class="close" (click)="closeImportModal()">×</button>
        </div>
      </div>
      <div class="modal-body">
        <label class="file-drop" [class.has-file]="selectedFile">
          <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)">
          <i class="fas fa-file-excel icon"></i>
          <div class="texts">
            <strong>{{ selectedFile ? selectedFile.name : 'Click to upload or drag & drop' }}</strong>
            <span>Only .xlsx or .xls files are supported</span>
          </div>
        </label>
        <p class="hint">Required columns: firstname, lastname, email, mobilenumber, addressline1, city, state, pincode. Optional: addressline2, center, role, password.</p>
        <div *ngIf="importSummary" class="import-summary">
          <p>Created: {{ importSummary.created }}</p>
          <p>Updated: {{ importSummary.updated }}</p>
          <p>Skipped: {{ importSummary.skipped }}</p>
          <div *ngIf="importErrors.length">
            <h4>Errors ({{ importSummary.errors.length }})</h4>
            <div class="errors-list">
              <div class="error-item" *ngFor="let e of importErrors | slice:0:5; let i = index">
                <span class="idx">#{{ i + 1 }}</span>
                <span class="msg">{{ e.email || e.index || '-' }} - {{ e.error }}</span>
              </div>
              <div class="more" *ngIf="importErrors.length > 5">and {{ importErrors.length - 5 }} more…</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closeImportModal()">Close</button>
        <button class="btn btn-primary" [disabled]="!selectedFile || importing" (click)="startImport()">
          <span *ngIf="importing" class="spinner"></span>
          Import
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading users...</p>
  </div>

  <!-- Users Table -->
  <div *ngIf="!loading && users.length > 0" class="users-table">
    <table>
      <thead>
        <tr>
          <th (click)="onSort('firstname')" class="sortable">
            User
            <i class="fas fa-sort" *ngIf="sortBy !== 'firstname'"></i>
            <i class="fas fa-sort-up" *ngIf="sortBy === 'firstname' && sortOrder === 'asc'"></i>
            <i class="fas fa-sort-down" *ngIf="sortBy === 'firstname' && sortOrder === 'desc'"></i>
          </th>
          <th (click)="onSort('email')" class="sortable">
            Email
            <i class="fas fa-sort" *ngIf="sortBy !== 'email'"></i>
            <i class="fas fa-sort-up" *ngIf="sortBy === 'email' && sortOrder === 'asc'"></i>
            <i class="fas fa-sort-down" *ngIf="sortBy === 'email' && sortOrder === 'desc'"></i>
          </th>
          <th>Role</th>
          <th>Mobile</th>
          <th>Taluka</th>
          <th (click)="onSort('createdAt')" class="sortable">
            Created Date
            <i class="fas fa-sort" *ngIf="sortBy !== 'createdAt'"></i>
            <i class="fas fa-sort-up" *ngIf="sortBy === 'createdAt' && sortOrder === 'asc'"></i>
            <i class="fas fa-sort-down" *ngIf="sortBy === 'createdAt' && sortOrder === 'desc'"></i>
          </th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td class="user-cell">
            <img [src]="getProfileImage(user)" [alt]="getFullName(user)" class="user-avatar">
            <span class="user-name">{{ getFullName(user) }}</span>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <span class="role-badge" [ngClass]="getRoleClass(user)">
              {{ user?.role?.displayName || user?.role?.name || 'No Role' }}
            </span>
          </td>
          <td>{{ user.mobilenumber }}</td>
          <td>{{ user.center }}</td>
          <td>{{ user.createdAt | date:'shortDate' }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(user.isActive)">
              {{ getStatusText(user.isActive) }}
            </span>
          </td>
          <td class="actions">
            <button class="btn-icon view" title="View Details" (click)="viewUserDetails(user._id)">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon edit" title="Edit" (click)="openEditUserModal(user)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon delete" title="Delete" (click)="openDeleteUserModal(user)">
              <i class="fas fa-trash"></i>
            </button>
            <button class="btn-icon logs" title="View Logs" (click)="openLogsModal(user._id)">
              <i class="fas fa-clipboard-list"></i>
            </button>
            <span *ngIf="!user.isLoggedIn" class="login-status" [class.logged-in]="user.isLoggedIn" [class.logged-out]="!user.isLoggedIn" [title]="user.isLoggedIn ? 'Currently logged in' : 'Not logged in'">
              <i class="fas fa-circle"></i>
            </span>
            <button *ngIf="user.isLoggedIn" class="btn-icon logout" title="Logout from All Devices" (click)="openLogoutModal(user)" [disabled]="!user.isLoggedIn">
              <i class="fas fa-sign-out-alt"></i>
            </button>
            <button class="btn-icon" [class.activate]="!user.isActive" [class.deactivate]="user.isActive" [title]="user.isActive ? 'Deactivate' : 'Activate'" (click)="openStatusModal(user)">
              <i class="fas" [ngClass]="user.isActive ? 'fa-user-slash' : 'fa-user-check'"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && users.length === 0" class="empty-state">
    <i class="fas fa-users"></i>
    <p>No users found</p>
  </div>

  <!-- Activate/Deactivate Confirmation Modal -->
  <app-confirm-modal
    [isOpen]="showStatusModal"
    [title]="nextActiveState ? 'Activate User' : 'Deactivate User'"
    [message]="(nextActiveState ? 'Are you sure you want to activate ' : 'Are you sure you want to deactivate ') + (selectedUser ? getFullName(selectedUser) : '') + '?'"
    [confirmText]="nextActiveState ? 'Activate' : 'Deactivate'"
    cancelText="Cancel"
    [confirmButtonClass]="nextActiveState ? 'btn-primary' : 'btn-danger'"
    [loading]="statusLoading"
    (confirm)="onStatusConfirm()"
    (cancel)="closeStatusModal()">
  </app-confirm-modal>

  <!-- Pagination and Rows Selection -->
  <div *ngIf="!loading && totalPages > 1" class="pagination-container">
    <div class="pagination">
      <button
        class="btn-page"
        [disabled]="currentPage === 1"
        (click)="onPageChange(1)"
        title="First">
        <i class="fas fa-angle-double-left"></i>
      </button>
      <button
        class="btn-page"
        [disabled]="currentPage === 1"
        (click)="onPageChange(currentPage - 1)">
        <i class="fas fa-chevron-left"></i>
      </button>

      <button
        *ngFor="let page of pages"
        class="btn-page"
        [class.active]="page === currentPage"
        (click)="onPageChange(page)">
        {{ page }}
      </button>

      <button
        class="btn-page"
        [disabled]="currentPage === totalPages"
        (click)="onPageChange(currentPage + 1)">
        <i class="fas fa-chevron-right"></i>
      </button>
      <button
        class="btn-page"
        [disabled]="currentPage === totalPages"
        (click)="onPageChange(totalPages)"
        title="Last">
        <i class="fas fa-angle-double-right"></i>
      </button>
    </div>

    <div class="rows-selection">
      <label for="pageSize">Rows</label>
      <select id="pageSize" [ngModel]="pageSize" (ngModelChange)="onPageSizeChange($event)">
        <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
      </select>
    </div>
  </div>

  <!-- User Form Modal -->
  <app-user-form-modal
    [isOpen]="showUserModal"
    [user]="selectedUser"
    (closeModal)="closeUserModal()"
    (userSaved)="onUserSaved($event)">
  </app-user-form-modal>

  <!-- Delete Confirmation Modal -->
  <app-confirm-modal
    [isOpen]="showDeleteModal"
    title="Delete User"
    [message]="'Are you sure you want to delete ' + (selectedUser ? getFullName(selectedUser) : '') + '? This action cannot be undone.'"
    confirmText="Delete User"
    cancelText="Cancel"
    confirmButtonClass="btn-danger"
    [loading]="deleteLoading"
    (confirm)="onDeleteConfirm()"
    (cancel)="closeDeleteModal()">
  </app-confirm-modal>

  <!-- Logout from All Devices Confirmation Modal -->
  <app-confirm-modal
    [isOpen]="showLogoutModal"
    title="Logout from All Devices"
    [message]="'Are you sure you want to logout ' + (selectedUser ? getFullName(selectedUser) : '') + ' from all devices? This will invalidate all active sessions.'"
    confirmText="Logout from All Devices"
    cancelText="Cancel"
    confirmButtonClass="btn-warning"
    [loading]="logoutLoading"
    (confirm)="onLogoutConfirm()"
    (cancel)="closeLogoutModal()">
  </app-confirm-modal>

  <!-- Logs Modal -->
  <div class="modal-overlay" *ngIf="showLogsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>User Audit Logs</h3>
        <button class="close" (click)="closeLogsModal()">×</button>
      </div>
      <div class="modal-body">
        <div *ngIf="userLogs.length === 0" class="empty-state">
          <i class="fas fa-clipboard-list"></i>
          <p>No logs exist for this user</p>
        </div>
        <div *ngFor="let log of userLogs; let i = index" class="log-entry" [ngClass]="{ 'odd': i % 2 === 1, 'even': i % 2 === 0 }">
          <div class="log-meta">
            <span class="log-action" [ngClass]="{
              'action-create': log.action === 'create',
              'action-update': log.action === 'update',
              'action-delete': log.action === 'delete'
            }">{{ log.action | titlecase }}</span>
            <span class="log-by">by {{ log.performedByEmail || log.performedBy }}</span>
            <span class="log-time">{{ log.createdAt | date:'medium' }}</span>
          </div>
          <div class="log-changes">
            <div class="change" *ngFor="let c of log.changes">
              <div class="field">{{ c.field }}</div>
              <div class="values">
                <div class="old" *ngIf="log.action !== 'create' && c.oldValue !== undefined">
                  <label>Old</label>
                  <pre>{{ c.oldValue | json }}</pre>
                </div>
                <div class="new" *ngIf="log.action !== 'delete' && c.newValue !== undefined">
                  <label>New</label>
                  <pre>{{ c.newValue | json }}</pre>
                </div>
              </div>
            </div>
            <div class="no-field-changes" *ngIf="!log.changes || log.changes.length === 0">
              No field-level changes captured.
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closeLogsModal()">Close</button>
      </div>
    </div>
  </div>
</div>
