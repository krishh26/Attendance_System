<div class="roles-container">
  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card">
      <div class="card-icon">
        <i class="fas fa-user-shield"></i>
      </div>
      <div class="card-content">
        <h3>Total Roles</h3>
        <p>{{ summaryStats.totalRoles }}</p>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon active">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="card-content">
        <h3>Active Roles</h3>
        <p>{{ summaryStats.activeRoles }}</p>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon permissions">
        <i class="fas fa-key"></i>
      </div>
      <div class="card-content">
        <h3>Total Permissions</h3>
        <p>{{ summaryStats.totalPermissions }}</p>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon users">
        <i class="fas fa-users-cog"></i>
      </div>
      <div class="card-content">
        <h3>Users with Roles</h3>
        <p>{{ summaryStats.usersWithRoles }}</p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-section">
    <div class="header">
      <h1>Roles & Permissions</h1>
      <button
        class="btn-add"
        *ngIf="canCreateRole()"
        (click)="openCreateRoleModal()">
        <i class="fas fa-plus"></i>
        Create New Role
      </button>
    </div>

    <!-- Enhanced Filters -->
    <div class="filters-container">
      <div class="filters-header">
        <h3 class="filters-title">
          <i class="fas fa-filter"></i>
          Filters & Search
        </h3>
        <button
          class="btn-clear-filters"
          (click)="clearAllFilters()"
          [disabled]="!hasActiveFilters()">
          <i class="fas fa-times"></i>
          Clear All
        </button>
      </div>

      <div class="filters-content">
        <!-- Search Section -->
        <div class="filter-section">
          <label class="filter-label">
            <i class="fas fa-search"></i>
            Search Roles
          </label>
          <div class="search-container">
            <input
              type="text"
              placeholder="Type role name or description..."
              [value]="searchTerm"
              (input)="onSearchChange($event)"
              class="search-input">
            <button
              class="btn-clear-search"
              (click)="clearSearch()"
              *ngIf="searchTerm"
              title="Clear search">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Status Filter Section -->
        <div class="filter-section">
          <label class="filter-label">
            <i class="fas fa-toggle-on"></i>
            Filter by Status
          </label>
          <div class="status-filters">
            <button
              class="status-chip"
              [class.active]="statusFilter === 'all'"
              (click)="onStatusFilterChange('all')">
              <i class="fas fa-list"></i>
              <span>All</span>
              <span class="count" *ngIf="summaryStats.totalRoles > 0">{{ summaryStats.totalRoles }}</span>
            </button>
            <button
              class="status-chip active"
              [class.active]="statusFilter === 'active'"
              (click)="onStatusFilterChange('active')">
              <i class="fas fa-check-circle"></i>
              <span>Active</span>
              <span class="count" *ngIf="summaryStats.activeRoles > 0">{{ summaryStats.activeRoles }}</span>
            </button>
            <button
              class="status-chip inactive"
              [class.active]="statusFilter === 'inactive'"
              (click)="onStatusFilterChange('inactive')">
              <i class="fas fa-times-circle"></i>
              <span>Inactive</span>
              <span class="count" *ngIf="(summaryStats.totalRoles - summaryStats.activeRoles) > 0">{{ summaryStats.totalRoles - summaryStats.activeRoles }}</span>
            </button>
          </div>
        </div>

        <!-- Actions Section -->
        <div class="filter-section">
          <label class="filter-label">
            <i class="fas fa-cog"></i>
            Actions
          </label>
          <div class="actions-container">
            <button
              class="btn-refresh"
              (click)="refreshRoles()"
              [disabled]="loading"
              title="Refresh roles">
              <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i>
              <span>Refresh</span>
            </button>
            <button
              class="btn-sort"
              (click)="toggleSort()"
              title="Toggle sort order">
              <i class="fas" [class.fa-sort-alpha-down]="sortOrder === 'asc'" [class.fa-sort-alpha-up]="sortOrder === 'desc'"></i>
              <span>Sort</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading roles...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="error && !loading">
      <i class="fas fa-exclamation-triangle"></i>
      <p>{{ error }}</p>
      <button class="btn-retry" (click)="loadRoles()">Retry</button>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loading && !error && roles.length === 0">
      <i class="fas fa-user-shield"></i>
      <p>No roles found</p>
      <p class="subtitle">Create your first role to get started</p>
    </div>

    <!-- Roles Cards -->
    <div class="roles-grid" *ngIf="!loading && !error && roles.length > 0">
      <div class="role-card" *ngFor="let role of roles" [class.inactive]="!role.isActive">
        <div class="role-header">
          <div class="role-title">
            <div class="role-name">
              <h3>{{ role.name }}</h3>
              <span class="status-badge" [class.active]="role.isActive">
                <i class="fas" [class.fa-check-circle]="role.isActive" [class.fa-times-circle]="!role.isActive"></i>
                {{ role.isActive ? 'Active' : 'Inactive' }}
              </span>
            </div>
            <p class="role-description">{{ role.description || 'No description provided' }}</p>
          </div>
          <div class="role-actions">
            <button
              class="btn-action edit"
              title="Edit Role"
              *ngIf="canUpdateRole()"
              (click)="openEditRoleModal(role)">
              <i class="fas fa-edit"></i>
            </button>
            <button
              class="btn-action view"
              title="View Details"
              *ngIf="canViewRoleDetails()"
              (click)="viewRoleDetails(role._id)">
              <i class="fas fa-eye"></i>
            </button>
            <button
              class="btn-action delete"
              title="Delete Role"
              *ngIf="canDeleteRole()"
              (click)="openDeleteRoleModal(role)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="role-stats">
          <div class="stat">
            <div class="stat-icon">
              <i class="fas fa-key"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ getTotalActions(role.permissions) }}</span>
              <span class="stat-label">Actions</span>
            </div>
          </div>
          <div class="stat">
            <div class="stat-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ role.createdAt | date:'MMM dd' }}</span>
              <span class="stat-label">Created</span>
            </div>
          </div>
          <div class="stat">
            <div class="stat-icon">
              <i class="fas fa-layer-group"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ getPermissionGroups(role?.permissions || [])['length'] }}</span>
              <span class="stat-label">Modules</span>
            </div>
          </div>
        </div>

        <div class="permissions-section">
          <div class="section-header">
            <h4>
              <i class="fas fa-shield-alt"></i>
              Permissions
            </h4>
            <span class="permission-count">{{ getTotalActions(role.permissions) }} total</span>
          </div>
          <div class="permissions-list">
            <div class="module-permissions" *ngFor="let module of getPermissionGroups(role?.permissions || []) | keyvalue">
              <div class="module-header">
                <span class="module-name">{{ module.key | titlecase }}</span>
                <span class="module-count">{{ module.value[0].actions.length }} actions</span>
              </div>
              <div class="permission-chips">
                <span class="permission-chip" *ngFor="let action of module.value[0].actions">
                  {{ action | titlecase }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="btn-page"
        [disabled]="currentPage === 1"
        (click)="onPageChange(currentPage - 1)">
        <i class="fas fa-chevron-left"></i>
      </button>

      <button
        class="btn-page"
        *ngFor="let page of pages"
        [class.active]="page === currentPage"
        (click)="onPageChange(page)">
        {{ page }}
      </button>

      <button
        class="btn-page"
        [disabled]="currentPage === totalPages"
        (click)="onPageChange(currentPage + 1)">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Create Role Modal -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="onRoleCancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <app-role-form
        (save)="onRoleSave($event)"
        (cancel)="onRoleCancel()">
      </app-role-form>
    </div>
  </div>

  <!-- Edit Role Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="onRoleCancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <app-role-form
        [role]="selectedRole"
        [isEditMode]="true"
        (save)="onRoleSave($event)"
        (cancel)="onRoleCancel()">
      </app-role-form>
    </div>
  </div>

  <!-- Delete Role Modal -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="onRoleCancel()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Delete Role</h3>
        <button class="btn-close" (click)="onRoleCancel()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the role <strong>"{{ selectedRole?.displayName }}"</strong>?</p>
        <p class="warning">This action cannot be undone and will remove all permissions associated with this role.</p>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="onRoleCancel()">Cancel</button>
        <button class="btn-delete" (click)="confirmDeleteRole()" [disabled]="loading">
          <i class="fas fa-trash" *ngIf="!loading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          Delete Role
        </button>
      </div>
    </div>
  </div>
</div>
