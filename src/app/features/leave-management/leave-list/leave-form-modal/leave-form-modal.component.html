<div class="modal-overlay" *ngIf="isOpen" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ getModalTitle() }}</h2>
      <button class="btn-close" (click)="onCancel()" title="Close">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Error Message -->
      <div *ngIf="error" class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
      </div>

      <form (ngSubmit)="onSubmit()" #leaveForm="ngForm">
        <!-- Employee Selection -->
        <div class="form-group">
          <label for="userId" [class.required]="!viewMode">Employee</label>
          <div *ngIf="viewMode" class="view-field">
            {{ getEmployeeName() }}
          </div>
          <div *ngIf="!viewMode" class="custom-select-wrapper">
            <div class="custom-select" [class.open]="isUsersDropdownOpen" [class.loading]="usersLoading">
              <div class="select-trigger" (click)="toggleUsersDropdown()">
                <input
                  type="text"
                  class="select-input"
                  [value]="getSelectedUserName()"
                  (focus)="isUsersDropdownOpen = true"
                  placeholder="Select or search employee..."
                  readonly>
                <i class="fas" [ngClass]="isUsersDropdownOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </div>
              <div class="select-dropdown" *ngIf="isUsersDropdownOpen">
                <div class="select-search">
                  <input
                    type="text"
                    [(ngModel)]="usersSearchTerm"
                    (input)="onUsersSearch($event)"
                    placeholder="Type to search..."
                    class="search-input">
                  <i class="fas fa-search"></i>
                </div>
                <div class="select-options" (scroll)="onUsersScroll($event)">
                  <div
                    *ngFor="let user of filteredUsers"
                    class="select-option"
                    [class.selected]="formData.userId === user._id"
                    (click)="selectUser(user)">
                    {{ getUserDisplayText(user) }}
                  </div>
                  <div *ngIf="usersLoading" class="select-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading more...
                  </div>
                  <div *ngIf="!usersLoading && filteredUsers.length === 0" class="select-empty">
                    No employees found
                  </div>
                  <div *ngIf="!usersHasMore && filteredUsers.length > 0" class="select-end">
                    End of list
                  </div>
                </div>
              </div>
            </div>
            <input
              type="hidden"
              id="userId"
              [(ngModel)]="formData.userId"
              name="userId"
              required>
          </div>
        </div>

        <!-- Leave Type -->
        <div class="form-group">
          <label for="leaveType" [class.required]="!viewMode">Leave Type</label>
          <div *ngIf="viewMode" class="view-field">
            {{ getLeaveTypeLabel(formData.leaveType) }}
            <span *ngIf="formData.isHalfDay" class="half-day-info">
              ({{ getHalfDayTypeLabel(formData.halfDayType || 'morning') }})
            </span>
          </div>
          <div *ngIf="!viewMode" class="select-wrapper">
            <select
              id="leaveType"
              [(ngModel)]="formData.leaveType"
              name="leaveType"
              required
              (change)="onLeaveTypeChange()">
              <option *ngFor="let type of leaveTypes" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>

        <!-- Date Range -->
        <div class="form-row">
          <div class="form-group">
            <label for="startDate" [class.required]="!viewMode">Start Date</label>
            <div *ngIf="viewMode" class="view-field">
              {{ formatDateForDisplay(formData.startDate) }}
            </div>
            <input
              *ngIf="!viewMode"
              type="date"
              id="startDate"
              [(ngModel)]="formData.startDate"
              name="startDate"
              required
              (change)="onStartDateChange()">
          </div>
          <div class="form-group">
            <label for="endDate" [class.required]="!viewMode">End Date</label>
            <div *ngIf="viewMode" class="view-field">
              {{ formatDateForDisplay(formData.endDate) }}
            </div>
            <input
              *ngIf="!viewMode"
              type="date"
              id="endDate"
              [(ngModel)]="formData.endDate"
              name="endDate"
              required>
          </div>
        </div>

        <!-- Half Day Options -->
        <div class="form-group" *ngIf="formData.leaveType === 'half-day' || formData.isHalfDay">
          <div *ngIf="viewMode" class="view-field">
            <span *ngIf="formData.isHalfDay">Half Day Leave</span>
            <span *ngIf="!formData.isHalfDay">Full Day Leave</span>
          </div>
          <div *ngIf="!viewMode" class="checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="formData.isHalfDay"
                name="isHalfDay"
                (change)="onHalfDayToggle()">
              <span class="checkmark"></span>
              Half Day Leave
            </label>
          </div>

          <div *ngIf="formData.isHalfDay && !viewMode" class="form-group">
            <label for="halfDayType">Half Day Type</label>
            <div class="select-wrapper">
              <select
                id="halfDayType"
                [(ngModel)]="formData.halfDayType"
                name="halfDayType">
                <option *ngFor="let type of halfDayTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>

        <!-- Reason -->
        <div class="form-group">
          <label for="reason" [class.required]="!viewMode">Reason</label>
          <div *ngIf="viewMode" class="view-field">
            {{ formData.reason }}
          </div>
          <textarea
            *ngIf="!viewMode"
            id="reason"
            [(ngModel)]="formData.reason"
            name="reason"
            required
            rows="3"
            placeholder="Please provide a reason for the leave request..."></textarea>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <div *ngIf="viewMode" class="view-field">
            {{ formData.notes || 'No additional notes' }}
          </div>
          <textarea
            *ngIf="!viewMode"
            id="notes"
            [(ngModel)]="formData.notes"
            name="notes"
            rows="2"
            placeholder="Any additional notes or comments..."></textarea>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onCancel()"
            [disabled]="loading">
            {{ viewMode ? 'Close' : 'Cancel' }}
          </button>
          <button
            *ngIf="!viewMode"
            type="submit"
            class="btn btn-primary"
            [disabled]="loading || !leaveForm.form.valid">
            <i *ngIf="loading" class="fas fa-spinner fa-spin"></i>
            {{ loading ? 'Saving...' : (isEditMode ? 'Update Leave Request' : 'Create Leave Request') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
